ARG TRANSCROBES_DOCKER_REPO
# Stage 0, "build-stage", based on Node.js, to build and compile the frontend
FROM node:16 as build-stage

LABEL maintainer="Anton Melser <anton@transcrob.es>"

WORKDIR /app
COPY ./frontend/package*.json /app/
RUN npm install --legacy-peer-deps

COPY ./frontend/ /app/

ARG ENVIRONMENT=prod

RUN npm run build:${ENVIRONMENT}

FROM ${TRANSCROBES_DOCKER_REPO:-transcrobes}/transcrobes-base

ENV PYTHONPATH=/app
ENV PYTHONUNBUFFERED=1

WORKDIR /app/
COPY --from=build-stage /app/dist /fapp

COPY ./backend/app/start.sh /start.sh
RUN chmod +x /start.sh

COPY ./backend/app/gunicorn_conf.py /gunicorn_conf.py

COPY ./backend/app/start-reload.sh /start-reload.sh
COPY ./backend/app/start-uvicorn.sh /start-uvicorn.sh
RUN chmod +x /start-reload.sh
RUN chmod +x /start-uvicorn.sh

CMD ["/bin/bash", "/start.sh"]
